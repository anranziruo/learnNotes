## 内容

### 快照
```
由于 Redis 是单线程程序, 还要同时负责多个客户端的并发读写操作和内存数据结构的逻辑读写. 所以快照持久化面临如下两个问题:

快照需要大量 IO 操作可能会阻塞线上业务, 拖慢整体性能, 而且快照又不能使用多路复用
持久化的同时, 还需要接受客户端请求, 正在持久的数据可能会被修改删除
Redis 使用 操作系统的多进程 COW ( Copy on Write ) 机制来实现快照持久化
```
### AOF
```
aof 日志存储的是 Redis 服务器的顺序指令序列, aof 日志只记录对内存进行修改的记录.
aof 同样也面临着两个问题:
随着实例的运行, 修改性指令序列越来越多, 在存储和重放(重启后恢复)上都存在着性能问题
aof 写日志文件的频率, 过快会因为IO拉升机器负载, 过慢如果机器突然宕机就会丢失数据
```
### AOF瘦身
```
Redis 提供了 bgrewriteaof 指令用于对 aof 日志瘦身. 其原理是开启一个子进程对现有内存数据进行遍历, 转换成一些列 Redis 操作指令, 序列化到一个新的 aof 日志文件中. 序列化完毕后的再将操作期间发生的增量 aof 日志追加到新的日志中, 然后代替旧的日志文件.
```
### 混合持久化
```
快照和aof日志都有各自的痛点
快照因为是每隔一段时间持久化一次, 就会丢失宕机时刻与上一次持久化之间的数据
aof 因为存储的是指令序列, 恢复重放时要花费很长时间
因此解决方案如下:
将 rdb 文件的内容和增量的 aof 日志放在一起
aof 日志只存储 rdb 持久化开始到当前发生的增量日志
重启时, 先加载 rbd 内容, 再重放增量 aof 日志
```
