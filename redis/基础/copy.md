## 内容

### redis的复制方式有以下三种
```
1)在配置文件中加入slaveof{masterHost}{masterPort}随Redis启动生 效。
2)在redis-server启动命令后加入--slaveof{masterHost}{masterPort}生 效。
3)直接使用命令:slaveof{masterHost}{masterPort}生效。
注意事项:slaveof配置都是在从节点发起
主从节点建立以后:
通过指令info replication命令查看复制相关状态
```
### 断开复制
```
在从节点执行slaveof no one来断 开与主节点复制关系,并且从丛服务器变成主服务器
断开复制主要流程:
1.断开与主节点复制关系。
2.从节点晋升为主节点。
```
### 切换主节点流程
```
1.断开与旧主节点复制关系。 
2.与新主节点建立复制关系。 
3.删除从节点当前所有数据。
4.对新主节点进行复制操作。
```
### 安全性复制
```
为了保障主节点和丛节点的安全复制 要配置从节点的 masterauth参数与主节点密码保持一致
```
### 丛节点为只读模式
```
默认情况下，从节点使用slave-read-only=yes配置为只读模式,丛节点设置成可写的话，会造成主从节点数据不一致的情况
```
### 传输延迟
```
Redis为我们提供了repl-disable-tcp-nodelay参数用于控制是否关闭 TCP_NODELAY，默认关闭
关闭时，主节点产生的命令数据无论大小都会及时地发送给从节点，这样主从之间延迟会变小，但增加了网络带宽的消耗,适用于同机房
开启时，主节点会合并较小的TCP数据包从而节省带宽。默认发送时间间隔取决于Linux的内核，一般默认为40毫秒。这种配置节省了带宽但增大主从之间的延迟
适用于主从网络环境复杂或带宽紧张的场景
```
### Redis的复制拓扑结构
```
结构如下:
一主一从、一主多从、树状主从结构
一主一从:
用于主节点出现宕机时从节点 提供故障转移支持,应用写命令并发量较高且需要持久 化时，可以只在从节点上开启AOF，这样既保证数据安全性同时也避免了持 久化对主节点的性能干扰,主节点关闭持久化功能,当主机重启时，从节点上执行 slaveof no one断开与主节点的复制关系，再重启主节点从而避免从机数据被清空
一主多从:
应用端可以利用多个从节点实现读写分离。对于读占比较大的场景，可以把读命令发送到 从节点来分担主节点压力.日常开发中如果需要执行一些比较耗时的 读命令，如:keys、sort等，可以在其中一台从节点上执行，防止慢查询对主节点造成阻塞从而影响线上服务的稳定性.写并发量较高的场景，多个从节点会导致主节点写命令的多次发送从而过度消耗网络带宽，同时也加 重了主节点的负载影响服务稳定性。
树状主从结构:
从节点不但可以复制主节点数据，同时可以作为其他从节点的主节点继续向下层复制.主节点需要挂载多个从节点时为了避免对主节点的性能干扰，可以采用树状主从结构降低主节点压力
```
### 复制过程
```
1.保存主节点(master)信息
2.从节点(slave)内部通过每秒运行的定时任务维护复制相关逻辑， 当定时任务发现存在新的主节点后，会尝试与该节点建立网络连接
3.从节点会建立一个socket套接字,节点无法建立连接，定时任务会无限重试直到连接成功或者执行 slaveof no one取消复制(连接失败，可以在从节点执行info replication查看 master_link_down_since_seconds指标，它会记录与主节点连接失败的系统时间)
4.发送ping命令
5.权限验证。如果主节点设置了requirepass参数，则需要密码验证， 从节点必须配置masterauth参数保证与主节点相同的密码才能通过验证;如 果验证失败复制将终止，从节点重新发起复制流程
6.同步数据集。主从复制连接正常通信后，对于首次建立复制的场 景，主节点会把持有的数据全部发送给从节点，这部分操作是耗时最长的步骤
7.命令持续复制。当主节点把当前的数据同步给从节点后，便完成了复制的建立流程。接下来主节点会持续地把写命令发送给从节点，保证主从数据一致性。
```

### psync命令
```
从节点使用psync命令完成部分复制和全量复制功能，命令格式:psync{runId}{offset}
runId:从节点所复制主节点的运行id。
(每个Redis节点启动后都会动态分配一个40位的十六进制字符串作为运行ID。运行ID的主要作用是用来唯一识别Redis节点，比如从节点保存主节点的运行ID识别自己正在复制的是哪个主节点)
offset:当前从节点已复制的数据偏移量。
流程说明:
1.从节点(slave)发送psync命令给主节点，参数runId是当前从节点保存的主节点运行ID，如果没有则默认值为，参数offset是当前从节点保存的 复制偏移量，如果是第一次参与复制则默认值为-1
2.回复+FULLRESYNC{runId}{offset}，那么从节点将触发全量复制流程
3.回复+CONTINUE，从节点将触发部分复制流程
4.回复+ERR,说明主节点版本低于Redis2.8，无法识别psync命令
```

### 全量复制
```
用于初次复制场景，Redis早期支持的复制功能只有全量复制，它会把主节点全部数据一次性发送给从节点，当数据量较大时，会对主从节点和网络造成很大的开销。
流程如下:
1.发送psync命令进行数据同步，由于是第一次进行复制，从节点没有复制偏移量和主节点的运行ID，所以发送psync-1
2.主节点根据psync-1解析出当前为全量复制，回复+FULLRESYNC响应
3.从节点接收主节点的响应数据保存运行ID和偏移量offset
4.主节点执行bgsave保存RDB文件到本地
5.主节点发送RDB文件给从节点，从节点把接收的RDB文件保存在本地并直接作为从节点的数据文件
6.对于从节点开始接收RDB快照到接收完成期间，主节点仍然响应读写命令，因此主节点会把这期间写命令数据保存在复制客户端缓冲区内，当从节点加载完RDB文件后，主节点再把缓冲区内的数据发送给从节点，保证主从之间数据一致性
7.从节点接收完主节点传送来的全部数据后会清空自身旧数据
8.从节点清空数据后开始加载RDB文件，对于较大的RDB文件，这一 步操作依然比较耗时，可以通过计算日志之间的时间差来判断加载RDB的总耗时
9.从节点成功加载完RDB后，如果当前节点开启了AOF持久化功能,它会立刻做bgrewriteaof操作，为了保证全量复制后AOF持久化文件立刻可用
全量复制(耗时分析):
1.主节点bgsave时间。
2.RDB文件网络传输时间。 
3.从节点清空数据时间。 
4.从节点加载RDB的时间。 
5.可能的AOF重写时间。
```
### 部分复制
```
部分复制主要是Redis针对全量复制的过高开销做出的一种优化措施， 使用psync{runId}{offset}命令实现。当从节点(slave)正在复制主节点 (master)时，
如果出现网络闪断或者命令丢失等异常情况时，从节点会向主节点要求补发丢失的命令数据，
如果主节点的复制积压缓冲区内存在这部分数据则直接发送给从节点，这样就可以保持主从节点复制的一致性。
部分复制流程如下:
1.主从节点之间网络出现中断时，如果超过repl-timeout时间，主节点会认为从节点故障并中断复制连接
2.主从连接中断期间主节点依然响应命令，但因复制连接中断命令无法发送给从节点，不过主节点内部存在的复制积压缓冲区，依然可以保存最近一段时间的写命令数据，默认最大缓存1MB
3.主从节点网络恢复后，从节点会再次连上主节点
4.当主从连接恢复后，由于从节点之前保存了自身已复制的偏移量和主节点的运行ID。因此会把它们当作psync参数发送给主节点，要求进行部分复制操作
5.主节点接到psync命令后首先核对参数runId是否与自身一致，如果一致，说明之前复制的是当前主节点;之后根据参数offset在自身复制积压缓冲区查找，如果偏移量之后的数据存在缓冲区中，则对从节点发送
+CONTINUE响应，表示可以进行部分复制
6.主节点根据偏移量把复制积压缓冲区里的数据发送给从节点，保证主从复制进入正常状态
```
### 复制积压缓冲区
```
复制积压缓冲区是保存在主节点上的一个固定长度的队列，默认大小为1MB，当主节点有连接的从节点(slave)时被创建，这时主节点(master)响应写命令时，
不但会把命令发送给从节点，还会写入复制积压缓冲区.
缓冲区本质上是先进先出的定长队列，所以能实现保存最近已复制
数据的功能，用于部分复制和复制命令丢失的数据补救
```
### 主从心跳
```
主->丛(ping)
主节点默认每隔10秒对从节点发送ping命令，判断从节点的存活性 和连接状态。可通过参数repl-ping-slave-period控制发送频率
丛->主(replconf ack)
从节点在主线程中每隔1秒发送replconf ack{offset}命令，给主节点上报自身当前的复制偏移量
流程如下:
1.上报自身复制偏移量，检查复制数据是否丢失，如果从节点数据丢失，再从主节点的复制缓冲区中拉取丢失数据
2.实现保证从节点的数量和延迟性功能，通过min-slaves-to-write、min-slaves-max-lag参数配置定义
3.主节点根据replconf命令判断从节点超时时间，体现在info replication统 计中的lag信息中，lag表示与从节点最后一次通信延迟的秒数，
正常延迟应该在0和1之间。如果超过repl-timeout配置的值(默认60秒)，则判定从节点 下线并断开复制客户端连接。即使主节点判定从节点下线后，如果从节点重新恢复，心跳检测会继续进行
```
### 异步复制
```
主节点不但负责数据读写，还负责把写命令同步给从节点。写命令的发送过程是异步完成，也就是说主节点自身处理完写命令后直接返回给客户端，并不等待从节点复制完成.
主节点复制流程:
1.主节点6379接收处理命令。
2.命令处理完之后返回响应结果。
3.对于修改命令异步发送给6380从节点，从节点在主线程中执行复制的命令
```


